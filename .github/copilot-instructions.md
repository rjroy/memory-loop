# Copilot Instructions

- **Scope**: Memory Loop is a Bun monorepo (backend Hono server, React 19 frontend, shared Zod protocol). Core protocol schemas live in [shared/src/protocol.ts](shared/src/protocol.ts) and are the source of truth for WebSocket message types.
- **Dev commands**: From repo root run `bun install`; `bun run dev` spins up both apps; `bun run test` runs backend then frontend; `bun run typecheck` and `bun run lint` fan out to all workspaces. Backend-only dev is `bun run --cwd backend dev`; frontend-only is `bun run --cwd frontend dev`.
- **Environments**: Requires `VAULTS_DIR` pointing at folders containing a `CLAUDE.md` per vault. Optional `MOCK_SDK=true` disables real Anthropic calls; backend serves on `PORT`/`HOST` (defaults 3000/0.0.0.0). Production uses `bun run build` then [scripts/launch.sh](scripts/launch.sh).
- **Backend shape**: Hono app in [backend/src/server.ts](backend/src/server.ts) exposes `/api/health`, `/api/vaults`, `/api/sessions/:vaultId`, vault asset passthrough under `/vault/:vaultId/assets/*` (image-only with traversal checks), and WebSocket `/ws` (per-connection handler instance). Static frontend is served from `frontend/dist`.
- **WebSocket flow**: Handler in [backend/src/websocket-handler.ts](backend/src/websocket-handler.ts) validates messages with `safeParseClientMessage`, routes by `type`, and emits JSON-serialized server messages. Streaming responses emit `response_start` → `response_chunk`* → `response_end`; tool invocations stream `tool_start`/`tool_input`/`tool_end`. Abort calls interrupt active queries.
- **Sessions**: Claude Agent SDK sessions are created/resumed via [backend/src/session-manager.ts](backend/src/session-manager.ts) with defaults in `DISCUSSION_MODE_OPTIONS` (auto-allowed read tools, `permissionMode=acceptEdits`, streaming enabled). Session metadata persists to `~/.memory-loop/sessions/*.json` and is pruned to the most recent five per vault; IDs are validated to avoid traversal.
- **Vault discovery and goals**: [backend/src/vault-manager.ts](backend/src/vault-manager.ts) scans `VAULTS_DIR` for directories containing `CLAUDE.md`, extracts the first `#` heading as the vault name, detects inbox paths from common patterns, and optionally loads goals from `06_Metadata/memory-loop/goals.md`. Goals are parsed into sections with a 9-item cap.
- **Note capture**: [backend/src/note-capture.ts](backend/src/note-capture.ts) writes to `00_Inbox/YYYY-MM-DD.md` (creates inbox as needed), appends under `## Capture` with `- [HH:MM] text`, preserves existing content, and normalizes CRLF. Empty text returns a protocol error.
- **File browsing**: [backend/src/file-browser.ts](backend/src/file-browser.ts) whitelists markdown reads only, rejects symlinks, enforces vault-boundary checks (`realpath`), and truncates reads >1MB. Directory listings skip dotfiles and sort dirs-first.
- **Inspiration**: [backend/src/inspiration-manager.ts](backend/src/inspiration-manager.ts) pulls contextual prompts from `06_Metadata/memory-loop/contextual-prompts.md` (weekday-only generation) and weekly quotes from `06_Metadata/memory-loop/general-inspiration.md`. Context gathering prioritizes recent daily notes and project/area README/index files with a 3200-char budget.
- **Frontend state**: [frontend/src/contexts/SessionContext.tsx](frontend/src/contexts/SessionContext.tsx) is the single source of truth (useReducer). Modes: home, note, discussion, browse. Vault ID and browser path persist via localStorage; messages are server-sourced only. Pinned folders are stored per-vault locally.
- **WebSocket client**: [frontend/src/hooks/useWebSocket.ts](frontend/src/hooks/useWebSocket.ts) builds the ws URL from the current origin, validates server messages with `safeParseServerMessage`, and auto-reconnects with exponential backoff. `useServerMessageHandler` in SessionContext consumes `session_ready`/`response_*` events and updates state.
- **UI composition**: Root shell in [frontend/src/App.tsx](frontend/src/App.tsx) gates on vault selection (`VaultSelect`), then renders mode-specific components (`HomeView`, `NoteCapture`, `Discussion`, `BrowseMode`) with header actions for new session and vault switch dialogs.
- **Testing**: Backend `bun run test` iterates all files under [backend/src/__tests__](backend/src/__tests__), often using temp dirs and mocked SDK. Frontend tests use `@testing-library/react` with happy-dom from [frontend/src/test-setup.ts](frontend/src/test-setup.ts). Protocol tests live in [shared/src/__tests__/protocol.test.ts](shared/src/__tests__/protocol.test.ts).
- **Common pitfalls**: WebSocket endpoints expect JSON matching protocol discriminators; invalid JSON returns `VALIDATION_ERROR`. File reads must be `.md` relative to vault root. When mocking, set `MOCK_SDK=true` before starting the backend; otherwise the SDK will try to spawn Claude Code.
