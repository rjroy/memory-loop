---
version: 1.0.0
status: Draft
created: 2025-12-26
last_updated: 2025-12-26
authored_by:
  - Claude Code (Reverse-Engineered)
---

# File Browser View Specification

**Reverse-Engineered**: true
**Source Module**: frontend/src/components/BrowseMode.tsx, frontend/src/components/FileTree.tsx, frontend/src/components/MarkdownViewer.tsx, backend/src/file-browser.ts

## Executive Summary

The File Browser View (also called "Browse Mode") provides a split-pane interface for exploring and viewing markdown files within an Obsidian vault through a web browser. Users can navigate a hierarchical file tree on the left to select files, which are then rendered with full markdown formatting on the right. The system supports responsive layouts for both desktop and mobile devices, with the tree panel collapsing into a slide-out overlay on smaller screens. All file access is secured within the vault boundary using path validation to prevent directory traversal attacks.

The feature enables users to browse their vault's structure and read notes without switching to the Obsidian desktop application, making it ideal for quick reference on mobile devices or web-based workflows. Wiki-links within rendered markdown are clickable and navigate to related notes, preserving the interconnected nature of Obsidian vaults.

## User Story

As a vault owner accessing Memory Loop from a mobile device or web browser, I want to browse and read my Obsidian notes in a file tree interface, so that I can quickly reference existing knowledge without opening the desktop application.

## Stakeholders

- **Primary**: Vault owners using Memory Loop's web interface on mobile or desktop browsers
- **Secondary**:
  - Backend developers maintaining file access security
  - Frontend developers managing responsive layouts
  - UX designers ensuring mobile-friendly navigation patterns

## Success Criteria

1. Users can navigate the entire vault directory structure through an expandable/collapsible tree interface
2. Markdown files render with proper formatting, including headings, lists, code blocks, and wiki-links
3. Path traversal attempts (e.g., `../../../etc/passwd`) are blocked at the backend with appropriate error messages
4. Mobile users can access the file tree via an overlay that doesn't obscure content when dismissed
5. File tree maintains expansion state during navigation (expanded folders remain open)
6. Wiki-link navigation works correctly for both root and nested files with relative path resolution

## Functional Requirements

### File Tree Navigation

- **REQ-F-1**: System must list all files and directories in the vault root when Browse Mode loads
- **REQ-F-2**: System must display directories before files in listings, sorted alphabetically (case-insensitive) within each group
- **REQ-F-3**: System must allow users to expand directories to reveal child entries via click or keyboard (Enter/Space)
- **REQ-F-4**: System must collapse expanded directories when clicked again (toggle behavior)
- **REQ-F-5**: System must lazy-load directory contents only when first expanded (not pre-load entire tree)
- **REQ-F-6**: System must cache directory listings after first load to avoid redundant requests
- **REQ-F-7**: System must exclude hidden files and directories (names starting with `.`)
- **REQ-F-8**: System must exclude symbolic links from directory listings and reject symlink access attempts
- **REQ-F-9**: System must show loading spinner while directory contents are being fetched
- **REQ-F-10**: System must display "(empty)" placeholder for directories with no visible children
- **REQ-F-11**: System must support nested directory expansion up to arbitrary depth
- **REQ-F-12**: System must visually indent nested items based on depth (12px base + 16px per level)
- **REQ-F-13**: System must allow users to pin folders/files to a "Pinned" section at the top of the tree via right-click or long-press
- **REQ-F-14**: System must allow users to unpin items via the same context menu
- **REQ-F-15**: System must persist pinned items across sessions (stored in SessionContext)

### File Content Viewing

- **REQ-F-16**: System must render markdown content when a file is selected from the tree
- **REQ-F-17**: System must support GitHub Flavored Markdown (GFM) features including tables, strikethrough, task lists
- **REQ-F-18**: System must parse and render wiki-links in the format `[[note-name]]` and `[[note-name|display text]]` as clickable elements
- **REQ-F-19**: System must navigate to the target note when a wiki-link is clicked, resolving relative paths based on current file location
- **REQ-F-20**: System must auto-append `.md` extension to wiki-link targets if not present
- **REQ-F-21**: System must render external links (http/https) with `target="_blank"` and `rel="noopener noreferrer"`
- **REQ-F-22**: System must display a breadcrumb navigation trail showing the current file's path (e.g., Root / docs / guide.md)
- **REQ-F-23**: System must allow users to click breadcrumb segments to navigate to parent directories
- **REQ-F-24**: System must prepend asset base URL to relative image paths (default: `/vault/assets`)
- **REQ-F-25**: System must preserve absolute image URLs without modification
- **REQ-F-26**: System must display truncation warning when file exceeds 1MB size limit
- **REQ-F-27**: System must show loading skeleton while file content is being fetched
- **REQ-F-28**: System must display error message when file cannot be read (e.g., "File not found")
- **REQ-F-29**: System must show empty state message ("Select a file to view its content") when no file is selected
- **REQ-F-30**: System must automatically load file content when navigating from external links (e.g., RecentActivity View button)

### Responsive Layout

- **REQ-F-31**: System must display split-pane layout on desktop (tree on left, viewer on right) using CSS Grid
- **REQ-F-32**: System must allow users to collapse the tree pane on desktop via toggle button
- **REQ-F-33**: System must adjust viewer width when tree pane is collapsed
- **REQ-F-34**: System must hide desktop tree pane on mobile viewports (typically < 768px)
- **REQ-F-35**: System must show hamburger menu button in viewer header on mobile
- **REQ-F-36**: System must display tree as slide-out overlay when menu button is tapped on mobile
- **REQ-F-37**: System must show backdrop overlay behind mobile tree to indicate modal state
- **REQ-F-38**: System must dismiss mobile tree when backdrop is tapped
- **REQ-F-39**: System must dismiss mobile tree when close button is tapped
- **REQ-F-40**: System must automatically dismiss mobile tree when a file is successfully loaded

### Path Security

- **REQ-F-41**: Backend must validate all file/directory paths are within vault boundary before accessing filesystem
- **REQ-F-42**: Backend must reject path traversal attempts (e.g., `../`, `../../etc/passwd`) with `PATH_TRAVERSAL` error code
- **REQ-F-43**: Backend must use `realpath` resolution to detect symlinks and boundary escapes
- **REQ-F-44**: Backend must only allow reading markdown files (`.md` or `.MD` extension, case-insensitive)
- **REQ-F-45**: Backend must return `INVALID_FILE_TYPE` error for non-markdown file read attempts
- **REQ-F-46**: Backend must return `FILE_NOT_FOUND` error when requested file doesn't exist
- **REQ-F-47**: Backend must return `DIRECTORY_NOT_FOUND` error when requested directory doesn't exist

### WebSocket Protocol

- **REQ-F-48**: Client must send `list_directory` message with relative path to request directory listing
- **REQ-F-49**: Server must respond with `directory_listing` message containing array of FileEntry objects
- **REQ-F-50**: Client must send `read_file` message with relative path to request file content
- **REQ-F-51**: Server must respond with `file_content` message containing content and truncation flag
- **REQ-F-52**: Server must send `error` message with appropriate error code when operations fail
- **REQ-F-53**: Client must handle WebSocket reconnection by re-sending vault selection and reloading current directory
- **REQ-F-54**: Client must wait for `session_ready` message before requesting directory listings

## Non-Functional Requirements

- **REQ-NF-1** (Performance): Directory listings of 100 files must complete within 500ms
- **REQ-NF-2** (Performance): File reads under 1MB must complete within 200ms
- **REQ-NF-3** (Performance): Tree rendering of 100 entries must not block UI thread (no frame drops)
- **REQ-NF-4** (Security): Path validation must use `realpath` to resolve symlinks and detect boundary escapes
- **REQ-NF-5** (Security): All user-provided paths must be validated before filesystem access
- **REQ-NF-6** (Security): Markdown rendering must sanitize HTML to prevent XSS attacks (react-markdown built-in)
- **REQ-NF-7** (Usability): Tree items must have minimum 44px touch target height for mobile accessibility
- **REQ-NF-8** (Usability): Loading states must be visually distinct with spinners or skeleton screens
- **REQ-NF-9** (Usability): Error messages must be user-friendly and not expose system paths
- **REQ-NF-10** (Maintainability): File tree and markdown viewer must be separate, reusable React components
- **REQ-NF-11** (Maintainability): File browser backend logic must be isolated in `file-browser.ts` module
- **REQ-NF-12** (Consistency): File paths must use forward slashes consistently across frontend and backend
- **REQ-NF-13** (Consistency): Empty path string represents vault root in all contexts
- **REQ-NF-14** (Accessibility): Tree navigation must support keyboard controls (Enter, Space, Arrow keys)
- **REQ-NF-15** (Accessibility): Mobile tree overlay must trap focus and support Escape key to dismiss
- **REQ-NF-16** (Reliability): Directory cache must survive WebSocket reconnections
- **REQ-NF-17** (Reliability): File truncation at 1MB must preserve valid UTF-8 encoding (no split characters)

## Explicit Constraints (DO NOT)

- Do NOT allow access to files outside the vault boundary (enforce strict path validation)
- Do NOT allow reading of non-markdown files (security risk, performance concern)
- Do NOT pre-load the entire vault directory tree on mount (lazy-load only)
- Do NOT follow symbolic links (security risk for path traversal)
- Do NOT expose absolute filesystem paths to the frontend (leak system structure)
- Do NOT render raw HTML in markdown without sanitization (XSS risk)
- Do NOT support file upload, deletion, or modification (read-only interface)
- Do NOT cache file content across sessions (only cache directory listings)
- Do NOT allow directory listing of files starting with `.` (system files, .obsidian config)

## Technical Context

- **Existing Stack**:
  - Frontend: React 19, TypeScript, Vite, Bun test
  - Backend: Bun, Hono, Node.js fs/promises
  - Protocol: WebSocket with Zod-validated discriminated unions
  - Markdown: react-markdown with remark-gfm plugin

- **Integration Points**:
  - SessionContext for vault selection and browser state management
  - useWebSocket hook for real-time communication with backend
  - VaultManager for vault path resolution
  - WebSocket handler for message routing

- **Patterns to Respect**:
  - Components in `frontend/src/components/` with co-located `.css` files
  - Backend modules in `backend/src/` with co-located `__tests__/` directories
  - Zod schemas in `shared/src/protocol.ts` for all WebSocket messages
  - Custom error classes with `.code` property for type-safe error handling
  - Strict TypeScript with no implicit any
  - Unit tests with filesystem mocking using temp directories
  - CSS Grid for layout (not flexbox for main structure)
  - Mobile-first responsive design with CSS media queries

## Acceptance Tests

1. **File Tree Renders Vault Root**: Given vault with files [notes.md, docs/], when Browse Mode loads, then tree displays both entries sorted (docs/ first)

2. **Directory Expansion Loads Children**: Given directory with nested files, when user clicks directory chevron, then children appear indented beneath parent

3. **File Selection Displays Content**: Given file tree with notes.md, when user clicks notes.md, then markdown content renders in viewer pane

4. **Wiki-Link Navigation Works**: Given file with `[[other-note]]` link, when user clicks link, then other-note.md loads in viewer

5. **Path Traversal Blocked**: Given user requests `../../../etc/passwd.md`, then server returns error with code `PATH_TRAVERSAL`

6. **Non-Markdown Files Rejected**: Given user requests `image.png`, then server returns error with code `INVALID_FILE_TYPE`

7. **Large File Truncated**: Given file larger than 1MB, when user opens file, then first 1MB displays with truncation warning banner

8. **Mobile Tree Overlay Functions**: Given mobile viewport, when user taps hamburger menu, then tree appears as overlay with backdrop

9. **Breadcrumb Navigation**: Given file at `docs/api/guide.md`, when breadcrumb displays "Root / docs / api / guide.md", then clicking "docs" navigates to docs directory

10. **Pinned Folders Persist**: Given user pins "Projects" folder, when user refreshes page, then "Projects" appears in Pinned section at top of tree

11. **Empty Directory Shows Placeholder**: Given directory with no visible files (all hidden), when user expands directory, then "(empty)" text displays

12. **Context Menu on Right-Click**: Given directory entry, when user right-clicks entry, then context menu appears with "Pin to top" option

13. **Long-Press for Mobile Context Menu**: Given directory entry on mobile, when user long-presses entry (500ms), then context menu appears

14. **Symlinks Excluded from Listings**: Given vault with symlink to external directory, when listing directory, then symlink does not appear in tree

15. **WebSocket Reconnection Recovers State**: Given user has expanded directories and selected file, when WebSocket reconnects, then expanded state preserved and file remains visible

16. **Auto-Load from External Navigation**: Given RecentActivity shows "View" button for note.md, when user clicks "View" and switches to Browse mode, then note.md automatically loads in viewer

17. **Keyboard Navigation in Tree**: Given focused directory entry, when user presses Enter key, then directory expands/collapses

18. **External Links Open in New Tab**: Given markdown with `[Example](https://example.com)`, when rendered, then link has `target="_blank"` and `rel="noopener noreferrer"`

19. **Hidden Files Excluded**: Given vault with `.obsidian/` directory, when listing root, then `.obsidian/` does not appear

20. **Case-Insensitive Extension Check**: Given file named `note.MD` (uppercase), when user selects file, then content loads successfully

## Open Questions

- [ ] Should the system support downloading markdown files as text for offline access?
- [ ] Should pinned items be stored server-side (in session metadata) or client-side (localStorage)?
- [ ] Should the file tree support drag-and-drop reordering of pinned items?
- [ ] Should the system support syntax highlighting for code blocks in markdown?
- [ ] Should breadcrumb segments show folder icons to distinguish from file names?

## Out of Scope

- File creation, editing, or deletion (read-only interface)
- Full-text search across vault files
- File preview for non-markdown files (images, PDFs, etc.)
- Syntax highlighting for code blocks (future enhancement)
- Multi-file selection or bulk operations
- File drag-and-drop reordering
- Customizable theme for markdown rendering
- Offline caching of file content (only directory structure cached)
- Conflict resolution for concurrent edits from desktop app
- Version history or git integration

---

**Next Phase**: This specification was reverse-engineered from existing implementation. Use `/spiral-grove:plan-generation` if refactoring or extending this feature.
