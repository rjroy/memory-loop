exports.id=697,exports.ids=[697],exports.modules={2488:()=>{},5640:()=>{},6333:(a,b,c)=>{"use strict";c.d(b,{h:()=>am});let d={debug:0,info:1,warn:2,error:3,silent:4},e=process.env.LOG_LEVEL||"info";function f(a){let b=(b,c,f)=>{if(d[b]<d[e])return;let g=function(a){let b=a.timestamp.split("T")[1]?.slice(0,12)??a.timestamp,c=`[${b}] [${a.level.toUpperCase().padEnd(5)}] [${a.module}]`;return`${c} ${a.message}`}({timestamp:new Date().toISOString(),level:b,module:a,message:c,data:f});switch(b){case"debug":case"info":console.log(g,void 0!==f?f:"");break;case"warn":console.warn(g,void 0!==f?f:"");break;case"error":console.error(g,void 0!==f?f:"")}};return{debug:(a,c)=>b("debug",a,c),info:(a,c)=>b("info",a,c),warn:(a,c)=>b("warn",a,c),error:(a,c)=>b("error",a,c)}}f("WS");let g=f("Vault"),h=f("Session");async function i(a,b,c,d,e){let f,g=[],i=new Map,j=new Map;for await(let k of a){if(e?.aborted){for(let a of(h.debug("Streaming aborted"),i.values()))"running"===a.status&&(a.status="complete",a.output="[Streaming aborted]");break}switch(h.debug(`SDK event: ${k.type}`,function(a){let b={type:a.type};if("stream_event"===a.type){let c=a.event;if("error"===c.type)return b.streamType="error",b;if(b.streamType=c.type,"index"in c&&"number"==typeof c.index&&(b.index=c.index),"content_block_start"===c.type){let a=c.content_block;b.contentBlock={type:a.type,id:"id"in a?a.id:void 0,name:"name"in a?a.name:void 0}}"content_block_delta"===c.type&&(b.deltaType=c.delta.type)}return b}(k)),k.type){case"stream_event":{let a=function(a,b,c,d,e){let f=a.event;if("error"===f.type){let a=f.error?.message??f.error?.type??"Unknown SDK error during streaming";return h.warn("Stream error event received",{error:f.error}),c.emit({type:"error",code:"SDK_ERROR",message:a}),""}if("content_block_start"===f.type){let{index:a,content_block:b}=f;if("tool_use"===b.type){let{id:f,name:g}=b;h.info(`Tool started: ${g} (${f})`),e.set(a,{type:"tool_use",toolUseId:f,toolName:g,inputJsonChunks:[]}),c.emit({type:"tool_start",toolName:g,toolUseId:f}),d.set(f,{toolUseId:f,toolName:g,status:"running"})}else if("text"===b.type&&(e.set(a,{type:"text"}),d.size>0))return"\n\n";return""}if("content_block_delta"===f.type){let{index:a,delta:d}=f;if("text_delta"===d.type){let{text:a}=d;return c.emit({type:"response_chunk",messageId:b,content:a}),a}if("input_json_delta"===d.type){let{partial_json:b}=d,c=e.get(a);b&&c?.type==="tool_use"&&c.inputJsonChunks&&c.inputJsonChunks.push(b)}return""}if("content_block_stop"===f.type){let{index:a}=f,b=e.get(a);if(b?.type==="tool_use"&&b.toolUseId&&b.inputJsonChunks){let a=b.inputJsonChunks.join("");try{let e=a?JSON.parse(a):{};h.debug(`Tool input complete for ${b.toolName}`,{inputLength:a.length}),c.emit({type:"tool_input",toolUseId:b.toolUseId,input:e});let f=d.get(b.toolUseId);f&&(f.input=e)}catch(c){h.warn(`Failed to parse tool input JSON for ${b.toolUseId}`,{jsonStr:a,err:c})}}e.delete(a)}return""}(k,b,c,i,j);a&&g.push(a);break}case"result":{let a=function(a,b,c,d){let e;if("success"!==a.subtype){let c;if(a.errors&&a.errors.length>0)c=a.errors.join("; ");else switch(a.subtype){case"error_max_turns":c="Conversation reached maximum turns limit.";break;case"error_max_budget_usd":c="Conversation exceeded budget limit.";break;case"error_max_structured_output_retries":c="Failed to generate structured output after maximum retries.";break;default:c="An error occurred during execution."}h.warn(`SDK result error: ${a.subtype}`,{errors:a.errors}),b.emit({type:"error",code:"SDK_ERROR",message:c})}let{usage:f,modelUsage:g}=a;if(f&&g){let a=(f.input_tokens??0)+(f.output_tokens??0);d.cumulativeTokens+=a;let b=Object.keys(g),c=d.activeModel??b[0];if(c&&g[c]){let b=g[c].contextWindow;b&&b>0&&(d.contextWindow=b,e=Math.max(0,Math.min(100,e=Math.round(100*d.cumulativeTokens/b))),h.debug(`Context usage: ${d.cumulativeTokens}/${b} = ${e}% (turn: +${a}, model: ${c})`))}}let i=a.result;if(!i||!Array.isArray(i.content))return e;for(let a of i.content)if("object"==typeof a&&null!==a&&"type"in a){if("tool_use"===a.type&&a.name&&a.id){let d=c.get(a.id);d?d.input||void 0===a.input||(d.input=a.input):(h.debug(`Tool ${a.name} (${a.id}) tracked from result event (fallback)`),c.set(a.id,{toolUseId:a.id,toolName:a.name,status:"running",input:a.input}),b.emit({type:"tool_start",toolName:a.name,toolUseId:a.id}),void 0!==a.input&&b.emit({type:"tool_input",toolUseId:a.id,input:a.input}))}else if("tool_result"===a.type&&a.tool_use_id){h.info(`Tool completed: ${a.tool_use_id}`),b.emit({type:"tool_end",toolUseId:a.tool_use_id,output:a.content??null});let d=c.get(a.tool_use_id);d&&(d.output=a.content??null,d.status="complete")}}return e}(k,c,i,d);void 0!==a&&(f=a);break}case"user":!function(a,b,c){let{message:d}=a,e=d.content;if(Array.isArray(e)){for(let a of e)if("object"==typeof a&&null!==a&&"type"in a&&"tool_result"===a.type&&"tool_use_id"in a){let d=a.tool_use_id,e="content"in a?a.content:null;h.info(`Tool completed (from user event): ${d}`),b.emit({type:"tool_end",toolUseId:d,output:e??null});let f=c.get(d);f&&(f.output=e??null,f.status="complete")}}}(k,c,i);break;case"system":!function(a,b){if("compact_boundary"===a.subtype&&a.compact_metadata){let c=a.compact_metadata.pre_tokens,d=Math.round(.3*c);h.info(`Compact boundary: pre_tokens=${c}, trigger=${a.compact_metadata.trigger}, resetting cumulative from ${b.cumulativeTokens} to ~${d}`),b.cumulativeTokens=d;return}"init"===a.subtype&&a.model&&(b.activeModel=a.model,h.info(`Active model: ${a.model}`))}(k,d)}}return{content:g.join(""),toolInvocations:Array.from(i.values()),contextUsage:f}}f("Server");var j=c(1455),k=c(6760),l=c(9334);class m extends Error{constructor(){super("SDK not initialized. Call initializeSdkProvider() at startup, or configureSdkForTesting() in tests."),this.name="SdkNotInitializedError"}}function n(){throw new m}var o=c(3136);let p=f("VaultConfig"),q=["opus","sonnet","haiku"],r=["black","purple","red","cyan","orange","blue","green","yellow"];async function s(a){let b=(0,k.join)(a,".memory-loop.json");if(!await B(b))return{};try{let a=await (0,j.readFile)(b,"utf-8"),c=JSON.parse(a);if("object"!=typeof c||null===c||Array.isArray(c))return p.warn(`Invalid config format in ${b}: expected object`),{};let d={};return"string"==typeof c.title&&(d.title=c.title),"string"==typeof c.subtitle&&(d.subtitle=c.subtitle),"string"==typeof c.contentRoot&&(d.contentRoot=c.contentRoot),"string"==typeof c.inboxPath&&(d.inboxPath=c.inboxPath),"string"==typeof c.metadataPath&&(d.metadataPath=c.metadataPath),"string"==typeof c.projectPath&&(d.projectPath=c.projectPath),"string"==typeof c.areaPath&&(d.areaPath=c.areaPath),"string"==typeof c.attachmentPath&&(d.attachmentPath=c.attachmentPath),"number"==typeof c.promptsPerGeneration&&c.promptsPerGeneration>0&&(d.promptsPerGeneration=Math.floor(c.promptsPerGeneration)),"number"==typeof c.maxPoolSize&&c.maxPoolSize>0&&(d.maxPoolSize=Math.floor(c.maxPoolSize)),"number"==typeof c.quotesPerWeek&&c.quotesPerWeek>0&&(d.quotesPerWeek=Math.floor(c.quotesPerWeek)),"number"==typeof c.recentCaptures&&c.recentCaptures>0&&(d.recentCaptures=Math.floor(c.recentCaptures)),"number"==typeof c.recentDiscussions&&c.recentDiscussions>0&&(d.recentDiscussions=Math.floor(c.recentDiscussions)),"string"==typeof c.discussionModel&&q.includes(c.discussionModel)&&(d.discussionModel=c.discussionModel),"number"==typeof c.order&&Number.isFinite(c.order)&&(d.order=c.order),"boolean"==typeof c.cardsEnabled&&(d.cardsEnabled=c.cardsEnabled),"boolean"==typeof c.viMode&&(d.viMode=c.viMode),Array.isArray(c.badges)&&(d.badges=c.badges.filter(a=>"object"==typeof a&&null!==a&&"string"==typeof a.text&&""!==a.text&&"string"==typeof a.color&&r.includes(a.color))),Array.isArray(c.pinnedAssets)&&(d.pinnedAssets=c.pinnedAssets.filter(a=>"string"==typeof a&&a.length>0)),d}catch(c){let a=c instanceof Error?c.message:String(c);return p.warn(`Failed to load config from ${b}: ${a}`),{}}}function t(a){return a.metadataPath??"06_Metadata/memory-loop"}function u(a){return a.recentDiscussions??5}function v(a){return a.discussionModel??"opus"}class w extends Error{constructor(a){super(a),this.name="VaultsDirError"}}let x=["00_Inbox","00-Inbox","Inbox","inbox","_Inbox","0-Inbox"],y=["05_Attachments","Attachments","attachments","assets","images"];function z(){let a=process.env.VAULTS_DIR||(0,k.join)(function(){let a=(0,o.fileURLToPath)("file:///home/rjroy/Projects/Worktrees/memory-loop/refactor-next-js-8npjk/backend/src/vault-manager.ts"),b=(0,k.dirname)(a),c=(0,k.dirname)(b);return(0,k.dirname)(c)}(),"vaults");return g.debug(`VAULTS_DIR: ${a}`),a}async function A(a){try{return await (0,j.access)(a),(await (0,j.stat)(a)).isDirectory()}catch{return!1}}async function B(a){try{return await (0,j.access)(a),(await (0,j.stat)(a)).isFile()}catch{return!1}}async function C(a){for(let b of x){let c=(0,k.join)(a,b);if(await A(c))return b}return"00_Inbox"}async function D(a,b){if(b.attachmentPath)return b.attachmentPath;for(let b of y){let c=(0,k.join)(a,b);if(await A(c))return b}return b.attachmentPath??"05_Attachments"}async function E(a,b){let c=function(a){let b=t(a);return(0,k.join)(b,"goals.md")}(b),d=(0,k.join)(a,c);if(await B(d))return c}async function F(a,b){let c,d=(0,k.join)(a,b);if(!await A(d))return null;let e=(0,k.join)(d,"CLAUDE.md"),f=await B(e);if(!f)return null;let g=await s(d),h=function(a,b){if(b.contentRoot){if(b.contentRoot.startsWith("/"))return p.warn(`Absolute path rejected in contentRoot: ${b.contentRoot}`),a;let c=(0,k.normalize)((0,k.join)(a,b.contentRoot)),d=(0,k.normalize)(a);return c.startsWith(d+"/")||c===d?c:(p.warn(`Path traversal attempt in contentRoot: ${b.contentRoot}`),a)}return a}(d,g),i=b;try{let a=await (0,j.readFile)(e,"utf-8"),b=function(a){for(let b of a.split("\n")){let a=b.trim();if(a.startsWith("# ")){let b=a.slice(2).trim();if(b.length>0){let a=b.indexOf(" - ");if(a>0){let c=b.slice(0,a).trim(),d=b.slice(a+3).trim();if(c.length>0)return{title:c,subtitle:d.length>0?d:void 0}}return{title:b}}}}return null}(a);b&&(i=b.title,c=b.subtitle)}catch{}g.title&&(i=g.title),void 0!==g.subtitle&&(c=g.subtitle||void 0);let l=g.inboxPath??await C(h),m=t(g),n=await E(h,g),o=await D(h,g),q=(0,k.join)(d,".memory-loop/setup-complete");return{id:b,name:i,subtitle:c,path:d,hasClaudeMd:f,contentRoot:h,inboxPath:l,metadataPath:m,goalsPath:n,attachmentPath:o,setupComplete:await B(q),discussionModel:v(g),promptsPerGeneration:g.promptsPerGeneration??5,maxPoolSize:g.maxPoolSize??50,quotesPerWeek:g.quotesPerWeek??1,recentCaptures:g.recentCaptures??5,recentDiscussions:u(g),badges:g.badges??[],order:g.order??999999,cardsEnabled:g.cardsEnabled??!0,viMode:g.viMode??!1}}async function G(a){if(await A(a))return!1;g.info(`Creating vaults directory: ${a}`);try{return await (0,j.mkdir)(a,{recursive:!0}),!0}catch(c){if(await A(a))return!1;let b=c instanceof Error?c.message:String(c);throw g.error(`Failed to create vaults directory: ${b}`),new w(`Failed to create vaults directory "${a}": ${b}`)}}async function H(){let a;g.info("Discovering vaults...");let b=z();await G(b)&&g.info(`Created vaults directory: ${b}`),g.info(`Scanning: ${b}`);try{a=await (0,j.readdir)(b),g.debug(`Found ${a.length} entries`)}catch(c){let a=c instanceof Error?c.message:String(c);throw g.error(`Failed to read VAULTS_DIR: ${a}`),new w(`Failed to read VAULTS_DIR "${b}": ${a}`)}let c=[];for(let d of a){if(d.startsWith(".")){g.debug(`Skipping hidden: ${d}`);continue}try{g.debug(`Checking: ${d}`);let a=await F(b,d);a?(g.info(`Found vault: ${a.id} (${a.name})`),c.push(a)):g.debug(`Not a vault (no CLAUDE.md): ${d}`)}catch(a){g.warn(`Failed to parse vault "${d}":`,a instanceof Error?a.message:String(a))}}return c.sort((a,b)=>a.order!==b.order?a.order-b.order:a.name.localeCompare(b.name)),g.info(`Discovery complete: ${c.length} vault(s) found`),c}async function I(a){g.info(`Looking up vault: ${a}`);let b=z();await G(b);let c=await F(b,a);return c?g.info(`Vault found: ${c.name} at ${c.path}`):g.warn(`Vault not found: ${a}`),c}function J(a){let b=a.getFullYear(),c=String(a.getMonth()+1).padStart(2,"0"),d=String(a.getDate()).padStart(2,"0");return`${b}-${c}-${d}`}function K(a){let b=String(a.getHours()).padStart(2,"0"),c=String(a.getMinutes()).padStart(2,"0");return`${b}:${c}`}class L extends Error{constructor(a){super(a),this.name="TranscriptError"}}async function M(a){let b=(0,k.join)((0,k.join)(a.contentRoot,a.inboxPath),"chats");if(!await A(b))try{await (0,j.mkdir)(b,{recursive:!0})}catch(c){let a=c instanceof Error?c.message:String(c);throw new L(`Failed to create chats directory "${b}": ${a}`)}return b}async function N(a,b,c,d=new Date){let e=await M(a),f=function(a,b){let c=J(b),d=K(b).replace(":",""),e=a.slice(0,5).toLowerCase();return`${c}-${d}-${e}.md`}(b,d),g=(0,k.join)(e,f),h=function(a,b,c){let d=J(c),e=K(c),f=function(a,b){let c=a.split("\n")[0].trim();return c.length<=60?c:c.slice(0,59)+"…"}(b,60);return`---
date: ${d}
time: "${e}"
session_id: ${a}
title: "${f.replace(/"/g,'\\"')}"
---

# Discussion - ${d} ${e}

`}(b,c,d);try{await (0,j.writeFile)(g,h,"utf-8")}catch(b){let a=b instanceof Error?b.message:String(b);throw new L(`Failed to create transcript "${g}": ${a}`)}return g}async function O(a,b){try{await (0,j.appendFile)(a,b,"utf-8")}catch(c){let b=c instanceof Error?c.message:String(c);throw new L(`Failed to append to transcript "${a}": ${b}`)}}var P=c(8723);async function Q(a,b){try{let c,d=await (0,j.realpath)(a);try{c=await (0,j.realpath)(b)}catch{c=(0,k.resolve)(b)}let e=d.endsWith("/")?d:d+"/";return c===d||c.startsWith(e)}catch{return!1}}f("FileBrowser");let R=f("VaultTransfer");class S extends Error{constructor(a,b){super(a),this.name="VaultTransferError",this.code=b}}function T(a){let b=(0,k.extname)(a).toLowerCase();if(".md"!==b)throw new S(`Only markdown (.md) files can be transferred. Got: ${b||"(no extension)"}`,"INVALID_FILE_TYPE")}async function U(a,b){let c=(0,k.join)(a,b);if(!await Q(a,c))throw new S(`Path "${b}" is outside the vault boundary`,"PATH_TRAVERSAL");return c}async function V(a){let{sourceVaultId:b,targetVaultId:c,sourcePath:d,targetPath:e=d,mode:f,overwrite:g=!1}=a;R.info(`Transferring file: ${b}:${d} -> ${c}:${e} (${f})`),T(d),T(e);let h=await I(b);if(!h)throw new S(`Source vault "${b}" not found`,"SOURCE_VAULT_NOT_FOUND");let i=await I(c);if(!i)throw new S(`Target vault "${c}" not found`,"TARGET_VAULT_NOT_FOUND");let l=await U(h.contentRoot,d),m=await U(i.contentRoot,e);try{let a=await (0,j.lstat)(l);if(a.isSymbolicLink())throw R.warn(`Symlink rejected: ${d}`),new S(`Source path "${d}" is a symbolic link and cannot be transferred`,"PATH_TRAVERSAL");if(!a.isFile())throw new S(`Source path "${d}" is not a file`,"SOURCE_FILE_NOT_FOUND")}catch(a){if(a instanceof S)throw a;throw new S(`Source file "${d}" does not exist in vault "${b}"`,"SOURCE_FILE_NOT_FOUND")}if(await B(m)){if(!g)throw new S(`Target file "${e}" already exists in vault "${c}". Set overwrite=true to replace.`,"TARGET_EXISTS");if((await (0,j.lstat)(m)).isSymbolicLink())throw R.warn(`Target symlink rejected: ${e}`),new S(`Target path "${e}" is a symbolic link and cannot be overwritten`,"PATH_TRAVERSAL")}let n=(0,k.dirname)(m);await A(n)||(await (0,j.mkdir)(n,{recursive:!0}),R.debug(`Created target directory: ${n}`));let o=(await (0,j.stat)(l)).size;if("copy"===f)await (0,j.copyFile)(l,m),R.info(`Copied ${o} bytes to ${m}`);else{await (0,j.copyFile)(l,m);try{await (0,j.unlink)(l)}catch(a){throw R.error(`Move copy succeeded but source deletion failed: ${l}`),new S(`File copied to target but source deletion failed: ${a instanceof Error?a.message:String(a)}. File exists in both locations.`,"TRANSFER_FAILED")}R.info(`Moved ${o} bytes to ${m}`)}return{sourceVaultId:b,targetVaultId:c,sourcePath:d,targetPath:e,mode:f,bytesTransferred:o}}async function W(){return(await H()).map(a=>({id:a.id,name:a.name,path:a.path}))}function X(){return(0,l.IO)({name:"vault-transfer",version:"1.0.0",tools:[(0,l.z6)("transfer_file","Transfer a markdown file from one vault to another. Use this when content is ready to be published from a private vault to a public one, or to reorganize content between vaults.",{sourceVaultId:P.YjP().describe("ID of the source vault (directory name in VAULTS_DIR)"),targetVaultId:P.YjP().describe("ID of the target vault (directory name in VAULTS_DIR)"),sourcePath:P.YjP().describe("Path to the file within the source vault (relative to vault root, must be .md)"),targetPath:P.YjP().optional().describe("Path for the file in target vault (defaults to same as source). Must be .md"),mode:P.k5n(["copy","move"]).describe("Whether to copy (keep original) or move (delete original)"),overwrite:P.zMY().optional().default(!1).describe("Whether to overwrite if target file already exists")},async a=>{try{let b=await V({sourceVaultId:a.sourceVaultId,targetVaultId:a.targetVaultId,sourcePath:a.sourcePath,targetPath:a.targetPath,mode:a.mode,overwrite:a.overwrite??!1}),c="copy"===b.mode?"Copied":"Moved";return{content:[{type:"text",text:`${c} file successfully.

From: ${b.sourceVaultId}/${b.sourcePath}
To: ${b.targetVaultId}/${b.targetPath}
Size: ${b.bytesTransferred} bytes`}]}}catch(b){let a=b instanceof Error?b.message:String(b);return R.error("Transfer failed:",a),{content:[{type:"text",text:`Transfer failed: ${a}`}]}}}),(0,l.z6)("list_vaults","List all available vaults that can be used as source or target for file transfers.",{},async()=>{try{let a=await W();if(0===a.length)return{content:[{type:"text",text:"No vaults found. Ensure VAULTS_DIR is configured and contains vaults with CLAUDE.md files."}]};let b=a.map(a=>`- ${a.id}: ${a.name}`).join("\n");return{content:[{type:"text",text:`Available vaults:

${b}`}]}}catch(b){let a=b instanceof Error?b.message:String(b);return R.error("Failed to list vaults:",a),{content:[{type:"text",text:`Failed to list vaults: ${a}`}]}}})]})}let Y={allowedTools:["Read","Glob","Grep","AskUserQuestion","WebFetch","WebSearch","Task","TodoWrite","TodoRead"],permissionMode:"acceptEdits",maxBudgetUsd:2,includePartialMessages:!0,settingSources:["local","project","user"]};class Z extends Error{constructor(a,b){super(a),this.code=b,this.name="SessionError"}}function $(a){return a instanceof Error?a.message.includes("ENOENT")?"Claude Code executable not found. Please ensure Claude Code is installed.":a.message.includes("EACCES")?"Permission denied. Unable to access required resources.":a.message.includes("authentication")?"Authentication failed. Please check your Anthropic API key.":a.message.includes("rate_limit")?"Rate limit exceeded. Please try again later.":a.message.includes("billing")?"Billing error. Please check your Anthropic account.":a.message.includes("invalid_request")?"Invalid request. The session or prompt may be malformed.":a.message.includes("server_error")?"Server error. The Anthropic API is temporarily unavailable.":a.message:"An unknown error occurred while communicating with Claude."}async function _(a){let b=(0,k.join)(a,".memory-loop/sessions");return await (0,j.mkdir)(b,{recursive:!0}),b}async function aa(a,b){var c=b;if(!c||0===c.length)throw new Z("Session ID cannot be empty","SESSION_INVALID");if(c.length>256)throw new Z("Session ID is too long","SESSION_INVALID");if(!/^[a-zA-Z0-9_.-]+$/.test(c))throw new Z("Session ID contains invalid characters","SESSION_INVALID");if(c.includes("..")||c.includes("/")||c.includes("\\"))throw new Z("Session ID contains path traversal characters","SESSION_INVALID");let d=await _(a);return(0,k.join)(d,`${b}.json`)}async function ab(a){try{let b=await aa(a.vaultPath,a.id),c=JSON.stringify(a,null,2);await (0,j.writeFile)(b,c,"utf-8")}catch(b){let a=b instanceof Error?b.message:String(b);throw new Z(`Failed to save session metadata: ${a}`,"STORAGE_ERROR")}}async function ac(a,b){try{let c=await aa(a,b);if(!await B(c))return null;let d=await (0,j.readFile)(c,"utf-8"),e=JSON.parse(d);if(!e.id||!e.vaultId||!e.vaultPath)throw new Z("Session file is missing required fields","SESSION_INVALID");return e.messages=e.messages??[],e}catch(b){if(b instanceof Z)throw b;if(b instanceof SyntaxError)throw new Z("Session file contains invalid JSON","SESSION_INVALID");let a=b instanceof Error?b.message:String(b);throw new Z(`Failed to load session metadata: ${a}`,"STORAGE_ERROR")}}async function ad(a,b=5){try{let c=await _(a);if(!await A(c))return;let d=await (0,j.readdir)(c),e=[];for(let b of d){if(!b.endsWith(".json"))continue;let d=b.slice(0,-5);try{let f=await ac(a,d);f&&e.push({sessionId:d,lastActive:new Date(f.lastActiveAt),filePath:(0,k.join)(c,b)})}catch{}}for(let a of(e.sort((a,b)=>b.lastActive.getTime()-a.lastActive.getTime()),e.slice(b)))try{await (0,j.unlink)(a.filePath),h.info(`Pruned old session: ${a.sessionId}`)}catch{h.warn(`Failed to delete session file: ${a.filePath}`)}}catch(a){h.warn("Failed to prune old sessions",a)}}async function ae(a,b,c){let d=await ac(a,b);if(!d)throw new Z(`Session "${b}" not found`,"SESSION_NOT_FOUND");if(d.messages.push(c),d.lastActiveAt=new Date().toISOString(),"user"===c.role&&!d.transcriptPath)try{let a=await I(d.vaultId);if(a){let e=new Date(c.timestamp);d.transcriptPath=await N(a,b,c.content,e),h.info(`[Session] Created transcript: ${d.transcriptPath}`)}else h.warn(`[Session] Vault "${d.vaultId}" not found, skipping transcript`)}catch(a){h.warn("[Session] Failed to initialize transcript:",a)}if(await ab(d),d.transcriptPath)try{let a=new Date(c.timestamp),b="user"===c.role?function(a,b){let c=K(b);return`## [${c}] User

${a}

`}(c.content,a):function(a,b,c){let d=K(c),e=`## [${d}] Assistant

`;if(b&&b.length>0)for(let a of b)e+=function(a){let b="complete"===a.status?"✓":"…",c=`> **Tool:** ${a.toolName}`;if(a.input&&"object"==typeof a.input){let b=a.input;if(b.pattern&&"string"==typeof b.pattern&&(c+=`
> Pattern: \`${b.pattern}\``),b.file_path&&"string"==typeof b.file_path&&(c+=`
> File: \`${b.file_path}\``),b.command&&"string"==typeof b.command){let a=b.command.length>80?b.command.slice(0,77)+"...":b.command;c+=`
> Command: \`${a}\``}}if(c+=`
> ${b}`,"complete"===a.status&&null!=a.output){let b="string"==typeof a.output?a.output:JSON.stringify(a.output);if(b.includes("Found")||b.includes("files")){let a=b.match(/Found (\d+) (?:files?|results?|matches?)/i);a&&(c+=` Found ${a[1]} files`)}}return c+"\n\n"}(a);return a.trim()&&(e+=a+"\n\n"),e}(c.content,c.toolInvocations,a);await O(d.transcriptPath,b)}catch(a){h.warn("[Session] Failed to append to transcript:",a)}h.info(`[Session] Appended ${c.role} message to session ${b.slice(0,8)}...`)}async function af(a){let b=await a.next();if(b.done)throw new Z("Query ended without producing any events","SDK_ERROR");let c=b.value,d=c.session_id;if(!d)throw new Z("First event did not contain session_id","SDK_ERROR");return{sessionId:d,firstEvent:c}}async function*ag(a,b){for await(let c of(yield a,b))yield c}function ah(a,b){return async(c,d)=>{let e=`tool_${Date.now()}_${Math.random().toString(36).slice(2,11)}`;if(h.info(`Tool permission requested: ${c} (${e})`),"AskUserQuestion"===c&&b){h.info("AskUserQuestion tool detected, routing to question handler");let a=d.questions;if(!a||!Array.isArray(a))return h.warn("AskUserQuestion called without valid questions array"),{behavior:"deny",message:"AskUserQuestion requires a valid questions array"};try{let c=await b(e,a);return h.info(`AskUserQuestion answers received for ${e}`),{behavior:"allow",updatedInput:{...d,answers:c}}}catch(a){return h.warn(`AskUserQuestion failed for ${e}:`,a),{behavior:"deny",message:"User cancelled or failed to answer questions"}}}return await a(e,c,d)?(h.info(`Tool permission granted: ${c} (${e})`),{behavior:"allow",updatedInput:d}):(h.info(`Tool permission denied: ${c} (${e})`),{behavior:"deny",message:`User denied permission for ${c}`})}}async function ai(a,b,c,d,e,f){let g=f??n();h.info(`Creating session for vault: ${a.id}`),h.info(`Vault path: ${a.path}`),h.debug(`Prompt: ${b.slice(0,100)}...`);try{h.info("Calling Claude Agent SDK query()...");let f=await s(a.path),i=v(f);h.info(`Using discussion model: ${i}`);let j=X(),k={...Y,model:i,...c,cwd:a.path,mcpServers:{...c?.mcpServers,"vault-transfer":j}};d&&(k.canUseTool=ah(d,e),h.info("Tool permission callback configured"),e&&h.info("AskUserQuestion callback configured")),h.debug("SDK options:",{model:k.model,allowedTools:k.allowedTools,permissionMode:k.permissionMode,hasCanUseTool:!!k.canUseTool});let l=g({prompt:b,options:k});h.info("Waiting for first SDK event...");let{sessionId:m,firstEvent:n}=await af(l);h.info(`Session created: ${m}`),h.debug("First event type:",n.type);let o=new Date().toISOString(),p={id:m,vaultId:a.id,vaultPath:a.path,createdAt:o,lastActiveAt:o,messages:[]};return await ab(p),h.info("Session metadata saved"),(async()=>{let b=await s(a.path),c=u(b);await ad(a.path,c)})(),{sessionId:m,events:ag(n,l),interrupt:()=>l.interrupt(),supportedCommands:()=>l.supportedCommands()}}catch(a){if(h.error("Failed to create session",a),a instanceof Z)throw a;throw new Z($(a),"SDK_ERROR")}}async function aj(a,b,c,d,e,f,g){let i=g??n();h.info(`Resuming session: ${b}`);let j=await ac(a,b);if(!j)throw h.warn(`Session not found: ${b}`),new Z(`Session "${b}" not found`,"SESSION_NOT_FOUND");h.info(`Session metadata loaded: vault=${j.vaultId}`);try{h.info("Calling Claude Agent SDK query() with resume...");let g=await s(a),k=v(g);h.info(`Using discussion model: ${k}`);let l=X(),m={...Y,model:k,...d,resume:b,cwd:j.vaultPath,mcpServers:{...d?.mcpServers,"vault-transfer":l}};e&&(m.canUseTool=ah(e,f),h.info("Tool permission callback configured"),f&&h.info("AskUserQuestion callback configured")),h.debug("SDK options:",{model:m.model,allowedTools:m.allowedTools,permissionMode:m.permissionMode,hasCanUseTool:!!m.canUseTool});let n=i({prompt:c,options:m});h.info("Waiting for first SDK event...");let{sessionId:o,firstEvent:p}=await af(n);return h.info(`Session resumed: ${o}`),j.lastActiveAt=new Date().toISOString(),await ab(j),{sessionId:o,events:ag(p,n),interrupt:()=>n.interrupt(),supportedCommands:()=>n.supportedCommands()}}catch(a){if(h.error("Failed to resume session",a),a instanceof Z)throw a;throw new Z($(a),"SDK_ERROR")}}function ak(){return`msg_${Date.now()}_${Math.random().toString(36).slice(2,11)}`}let al=null;function am(){return al||(al=function(){let a=null,b=null,c=null,d=!1,e=null,f={cumulativeTokens:0,contextWindow:null,activeModel:null},g=new Map,j=new Map,k=new Set;function l(a){for(let b of k)try{b(a)}catch(a){h.error("Subscriber callback threw error",a)}}let m={emit:l};function n(){return async(a,b,c)=>(h.info(`Requesting tool permission: ${b} (${a})`),new Promise((d,e)=>{let f={id:a,type:"tool_permission",toolName:b,input:c};g.set(a,{prompt:f,resolve:d,reject:e}),l({type:"prompt_pending",prompt:f})}))}function o(){return async(a,b)=>(h.info(`Requesting user input via AskUserQuestion: ${a}`),new Promise((c,d)=>{let e={id:a,type:"ask_user_question",questions:b};j.set(a,{prompt:e,resolve:c,reject:d}),l({type:"prompt_pending",prompt:e})}))}async function p(g,j,k,n){c=k,a=k.sessionId,b=g.id,g.path,d=!0,e=new AbortController;try{if(n){f.cumulativeTokens=0,f.contextWindow=null;try{(await k.supportedCommands()).map(a=>({name:a.name.startsWith("/")?a.name:`/${a.name}`,description:a.description,argumentHint:a.argumentHint||void 0}))}catch(a){h.warn("Failed to fetch slash commands",a)}l({type:"session_ready",sessionId:k.sessionId,vaultId:g.id,createdAt:new Date().toISOString()})}let a=ak();await ae(g.path,k.sessionId,{id:a,role:"user",content:j,timestamp:new Date().toISOString()});let b=ak(),c=Date.now();l({type:"response_start",messageId:b});let d=await i(k.events,b,m,f,e.signal),o=Date.now()-c;if(h.info(`Query completed in ${o}ms`),l({type:"response_end",messageId:b,contextUsage:d.contextUsage,durationMs:o}),d.content.length>0||d.toolInvocations.length>0){let a={id:b,role:"assistant",content:d.content,timestamp:new Date().toISOString(),toolInvocations:d.toolInvocations.length>0?d.toolInvocations:void 0,contextUsage:d.contextUsage,durationMs:o};await ae(g.path,k.sessionId,a)}}catch(a){h.error("Streaming failed",a),l({type:"error",code:"SDK_ERROR",message:a instanceof Error?a.message:"Streaming failed"})}finally{d=!1,e=null}}return{async startSession(b,d){h.info(`Starting session for vault: ${b.id}`),(c||a)&&await this.clearSession();try{let a=await ai(b,d,void 0,n(),o());await p(b,d,a,!0)}catch(a){h.error("Failed to start session",a),l({type:"error",code:"SDK_ERROR",message:a instanceof Error?a.message:"Failed to start session"})}},async resumeSession(b,c,d){h.info(`Resuming session: ${c}`);try{let e=await aj(b,c,d,void 0,n(),o()),f={id:e.sessionId.split("_")[0]||"unknown",name:"",path:b,hasClaudeMd:!0,contentRoot:"",inboxPath:"",metadataPath:"",attachmentPath:"",setupComplete:!0,promptsPerGeneration:10,maxPoolSize:50,quotesPerWeek:3,badges:[],order:1/0,cardsEnabled:!1,viMode:!1};a=c,await p(f,d,e,!1)}catch(a){h.error("Failed to resume session",a),l({type:"error",code:"SDK_ERROR",message:a instanceof Error?a.message:"Failed to resume session"})}},async clearSession(){if(h.info("Clearing session"),e&&e.abort(),c){try{await c.interrupt()}catch(a){h.warn("Failed to interrupt query",a)}c=null}for(let[a,b]of g)h.info(`Discarding pending permission: ${a}`),b.reject(Error("Session cleared"));for(let[a,b]of(g.clear(),j))h.info(`Discarding pending question: ${a}`),b.reject(Error("Session cleared"));j.clear(),a=null,b=null,f.cumulativeTokens=0,f.contextWindow=null,d=!1,l({type:"session_cleared"})},subscribe:a=>(k.add(a),h.debug(`Subscriber added, total: ${k.size}`),()=>{k.delete(a),h.debug(`Subscriber removed, total: ${k.size}`)}),getPendingPrompts(){let a=[];for(let b of g.values())a.push(b.prompt);for(let b of j.values())a.push(b.prompt);return a},getState:()=>({sessionId:a,vaultId:b,cumulativeTokens:f.cumulativeTokens,contextWindow:f.contextWindow,activeModel:f.activeModel,isStreaming:d}),isStreaming:()=>d,respondToPrompt(a,b){if(h.info(`Responding to prompt: ${a}`),"tool_permission"===b.type){let c=g.get(a);if(!c){h.warn(`Prompt not found: ${a}`),l({type:"prompt_response_rejected",promptId:a,reason:"not_found"});return}g.delete(a),c.resolve(b.allowed),l({type:"prompt_resolved",promptId:a})}else if("ask_user_question"===b.type){let c=j.get(a);if(!c){h.warn(`Question not found: ${a}`),l({type:"prompt_response_rejected",promptId:a,reason:"not_found"});return}j.delete(a),c.resolve(b.answers),l({type:"prompt_resolved",promptId:a})}}}}()),al}}};